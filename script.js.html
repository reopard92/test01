const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzoybbIaxOq4EtWaBkvdPNzkN1_7lmFRnAQLbnu6A40YUQdbzX6gTfIY5CznZs13GYxZw/exec";
const SCHEDULE_GAS_URL = "https://script.google.com/macros/s/AKfycbxkywDklSyaMf93hYhG-ULAyAEQ1qHGgaYjNewTxX34pfySOZKYsbwehygCccEvnchB/exec";
const COIN_MANAGER_URL = "https://script.google.com/macros/s/AKfycbzIKbpFP8mr9XWi0B_WFswRpVZ5o_SGnOFOYRdPMnLP4kK-e61CCXLN3bUod4eNodQl/exec";
const LOGIN_KEY = 'tennis_user_auth';
const STORAGE_KEY = 'tennis_match_data_v7_holo';
const members = ["Âë®Âπ≥", "„Åô„Åå", "ÂáåÁü¢", "Á•ê‰ªã", "ÂøóÊùë", "„Ç´„Éà„Ç±„É≥", "Â∞èÁî∞"];

let currentUser = null;
let currentCoins = 0;
let lastBonusDate = null;
let isEditMode = false;
let slotSymbols = ['7', 'üîî', 'üçí', 'üçá', 'üçã', 'üíé', 'üíÄ'];
let slotIntervals = [null, null, null];
let slotValues = [0, 0, 0];
let isSlotSpinning = [false, false, false];
let isLeverLocked = false;
let slotSessionDelta = 0;

window.onload = function() {
    initAuth();
    initSelectors();
    fetchAnalysisData();
    fetchWeather();
    const today = new Date();
    document.getElementById('matchDate').textContent = today.toISOString().split('T')[0];
    setTimeout(() => {
        document.getElementById('loadingScreen').style.opacity = 0;
        setTimeout(() => { document.getElementById('loadingScreen').style.display = 'none'; }, 800);
    }, 1000);
};

function initAuth() {
    const stored = localStorage.getItem(LOGIN_KEY);
    if (stored) {
        currentUser = JSON.parse(stored);
        fetchCoinData(currentUser.name);
    }
    updateUserDisplay();
}

function fetchCoinData(name) {
    if (!COIN_MANAGER_URL) return;
    fetch(`${COIN_MANAGER_URL}?user=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                currentCoins = parseInt(data.coins);
                updateUserDisplay();
                if(document.getElementById('view-mypage').classList.contains('active')) renderMyPage();
            }
        });
}

function updateUserDisplay() {
    const disp = document.getElementById('currentUserDisplay');
    if (currentUser) {
        disp.textContent = `${currentUser.name} : ü™ô${currentCoins.toLocaleString()}`;
        disp.className = 'user-status-display status-user';
    } else {
        disp.textContent = 'GUEST';
        disp.className = 'user-status-display status-guest';
    }
}

function attemptLogin() {
    const pass = document.getElementById('loginPassInput').value;
    if (pass === "8047") {
        currentUser = { name: "Âë®Âπ≥" };
        localStorage.setItem(LOGIN_KEY, JSON.stringify(currentUser));
        location.reload();
    } else {
        alert("ACCESS DENIED");
    }
}

function switchMainView(name) {
    document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(`view-${name}`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    document.getElementById('pageTitle').textContent = name.toUpperCase();
}

function showMyPage() {
    if (!currentUser) { document.getElementById('loginModal').style.display = 'flex'; return; }
    switchMainView('mypage');
    renderMyPage();
}

function renderMyPage() {
    const html = `
        <div class="mypage-header">
            <div class="mypage-avatar-large">${currentUser.name[0]}</div>
            <div class="mypage-name">${currentUser.name}</div>
        </div>
        <div class="mypage-coin-area"><div class="coin-val">${currentCoins.toLocaleString()}</div></div>
        <div style="text-align:center;"><button class="btn-logout" onclick="handleLogout()">LOGOUT</button></div>
    `;
    document.getElementById('myPageContent').innerHTML = html;
}

function handleLogout() { localStorage.removeItem(LOGIN_KEY); location.reload(); }
function toggleSideMenu() { document.getElementById('sideMenu').classList.toggle('open'); }
function closeSideMenu(e) { if(e.target.id === 'sideMenu') document.getElementById('sideMenu').classList.remove('open'); }
function selectAppMode(m) { toggleSideMenu(); switchMainView(m === 'tennis' ? 'top' : 'game'); }

/* SLOT MACHINE LOGIC */
function openSlotGame() { 
    if(!currentUser) { showToast("LOGIN REQUIRED"); return; } 
    document.getElementById('slotGameModal').style.display='flex'; 
    slotSessionDelta=0; 
    document.getElementById('slotWallet').innerText=currentCoins.toLocaleString(); 
}

function closeSlotGame(e) { 
    if(e.target.id==='slotGameModal'||e.target.className==='close-btn') { 
        saveSlotSession(); 
        document.getElementById('slotGameModal').style.display='none'; 
    } 
}

function pullSlotLever() {
    if(isLeverLocked || currentCoins < 20) return;
    isLeverLocked = true;
    const stick = document.querySelector('.slot-lever-stick'); 
    stick.classList.add('pulled');
    setTimeout(() => {
        stick.classList.remove('pulled');
        currentCoins -= 20; 
        slotSessionDelta -= 20;
        document.getElementById('slotWallet').innerText = currentCoins.toLocaleString();
        updateUserDisplay();
        startSlot();
    }, 300);
}

function startSlot() {
    for(let i=0; i<3; i++) {
        isSlotSpinning[i] = true; 
        document.getElementById(`stop${i+1}`).disabled = false;
        document.getElementById(`reel${i+1}`).classList.add('spinning');
        slotIntervals[i] = setInterval(() => {
            document.getElementById(`reel${i+1}`).innerText = slotSymbols[Math.floor(Math.random()*slotSymbols.length)];
        }, 100);
    }
}

function stopReel(idx) {
    if(!isSlotSpinning[idx]) return;
    clearInterval(slotIntervals[idx]);
    isSlotSpinning[idx] = false; 
    document.getElementById(`stop${idx+1}`).disabled = true;
    document.getElementById(`reel${idx+1}`).classList.remove('spinning');
    
    // „ÄêÈáçË¶Å„Äëüçí„ÅåÂá∫„ÇãÁ¢∫Áéá„Çí11%„Å´Âõ∫ÂÆö
    let finalSymbol;
    const rand = Math.random();
    if (rand < 0.11) {
        finalSymbol = 'üçí';
    } else {
        // üçí‰ª•Â§ñ„ÅÆÊÆã„Çä„ÅÆ„Ç∑„É≥„Éú„É´„Åã„ÇâÂùáÁ≠â„Å´ÈÅ∏Âá∫
        const others = slotSymbols.filter(s => s !== 'üçí');
        finalSymbol = others[Math.floor(Math.random() * others.length)];
    }
    
    slotValues[idx] = slotSymbols.indexOf(finalSymbol);
    document.getElementById(`reel${idx+1}`).innerText = finalSymbol;
    if(!isSlotSpinning.some(s=>s)) checkSlotResult();
}

function checkSlotResult() {
    const [v1,v2,v3] = slotValues.map(i=>slotSymbols[i]);
    let win = 0;
    if(v1===v2 && v2===v3) {
        if(v1==='7') win=7777; else if(v1==='üíé') win=1000; else if(v1==='üîî') win=500; else if(v1==='üçá') win=300; else if(v1==='üçí') win=100; else if(v1==='üíÄ') win=-1000;
    } else if([v1,v2,v3].includes('7')) win=20;
    currentCoins += win; 
    slotSessionDelta += win;
    document.getElementById('slotMessage').innerText = win>0 ? `WIN! +${win}` : (win<0 ? `LOST ${win}` : "TRY AGAIN");
    document.getElementById('slotWallet').innerText = currentCoins.toLocaleString();
    updateUserDisplay();
    isLeverLocked = false;
}

function saveSlotSession() {
    if(slotSessionDelta===0 || !COIN_MANAGER_URL) return;
    fetch(COIN_MANAGER_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({user:currentUser.name, action:'update', amount:slotSessionDelta}), keepalive:true });
}

/* OTHER UTILS */
function playCoinToss() {
    const c = document.getElementById('gameCoin'); if(c.classList.contains('spinning')) return;
    c.classList.add('spinning'); c.textContent="";
    setTimeout(() => { c.classList.remove('spinning'); c.textContent = Math.random()>0.5?"HEAD":"TAIL"; }, 1500);
}

function showToast(msg) { 
    const t=document.getElementById("toast"); t.textContent=msg; t.className="show"; 
    setTimeout(()=>{t.className=""},3000); 
}

function manualReload() { location.reload(); }

/* INITIALIZERS STUB */
function initSelectors() {
    ['r1', 'r2'].forEach(r => {
        [1,2,3,4,5].forEach(i => {
            const el = document.getElementById(`${r}_p${i}`);
            if(el) el.innerHTML = '<option value="-">-</option>' + members.map(m => `<option value="${m}">${m}</option>`).join('');
        });
    });
}
function updateSchedule(rp) {}
function fetchAnalysisData() {}
function fetchWeather() {}
function toggleEditMode() {}
function renderMapInfo(val) {}
