const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzoybbIaxOq4EtWaBkvdPNzkN1_7lmFRnAQLbnu6A40YUQdbzX6gTfIY5CznZs13GYxZw/exec";
const SCHEDULE_GAS_URL = "https://script.google.com/macros/s/AKfycbxkywDklSyaMf93hYhG-ULAyAEQ1qHGgaYjNewTxX34pfySOZKYsbwehygCccEvnchB/exec";
const COIN_MANAGER_URL = "https://script.google.com/macros/s/AKfycbzIKbpFP8mr9XWi0B_WFswRpVZ5o_SGnOFOYRdPMnLP4kK-e61CCXLN3bUod4eNodQl/exec";
const LOGIN_KEY = 'tennis_user_auth';
const STORAGE_KEY = 'tennis_match_data_v7_holo';
const members = ["Âë®Âπ≥", "„Åô„Åå", "ÂáåÁü¢", "Á•ê‰ªã", "ÂøóÊùë", "„Ç´„Éà„Ç±„É≥", "Â∞èÁî∞"];

let currentUser = null;
let currentCoins = 0;
let isEditMode = false;
let slotSymbols = ['7', 'üîî', 'üçí', 'üçá', 'üçã', 'üíé', 'üíÄ'];
let slotIntervals = [null, null, null];
let slotValues = [0, 0, 0];
let isSlotSpinning = [false, false, false];
let isLeverLocked = false;
let slotSessionDelta = 0;
let playerStatsGlobal = {};

window.onload = function() {
    // Á¢∫ÂÆü„Å´„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÊ∂à„Åô„Åü„ÇÅ„ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
    try {
        initAuth();
        initSelectors();
        fetchAnalysisData();
        fetchWeather();
        fetchScheduleData();

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const dateEl = document.getElementById('matchDate');
        if(dateEl) dateEl.textContent = `${yyyy}-${mm}-${dd}`;

        const lastView = sessionStorage.getItem('lastView') || 'top';
        switchMainView(lastView);

    } catch (e) {
        console.error("Initialization Error:", e);
    } finally {
        // ‰Ωï„Åå„ÅÇ„Å£„Å¶„ÇÇ1ÁßíÂæå„Å´„É≠„Éº„ÉÄ„Éº„ÇíÊ∂à„Åô
        setTimeout(() => {
            const loader = document.getElementById('loadingScreen');
            if (loader) {
                loader.style.opacity = 0;
                setTimeout(() => { loader.style.display = 'none'; }, 800);
            }
        }, 1000);
    }
};

function initAuth() {
    const stored = localStorage.getItem(LOGIN_KEY);
    if (stored) {
        currentUser = JSON.parse(stored);
        fetchCoinData(currentUser.name);
    }
    updateUserDisplay();
}

function fetchCoinData(name) {
    if (!COIN_MANAGER_URL) return;
    fetch(`${COIN_MANAGER_URL}?user=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                currentCoins = parseInt(data.coins);
                updateUserDisplay();
                if(document.getElementById('view-mypage')?.classList.contains('active')) renderMyPage();
            }
        }).catch(err => console.error("Coin fetch error:", err));
}

function updateUserDisplay() {
    const disp = document.getElementById('currentUserDisplay');
    if (!disp) return;
    if (currentUser) {
        disp.textContent = `${currentUser.name} : ü™ô${currentCoins.toLocaleString()}`;
        disp.className = 'user-status-display status-user';
    } else {
        disp.textContent = 'GUEST';
        disp.className = 'user-status-display status-guest';
    }
}

function attemptLogin() {
    const pass = document.getElementById('loginPassInput').value;
    if (pass === "8047") {
        currentUser = { name: "Âë®Âπ≥" };
        localStorage.setItem(LOGIN_KEY, JSON.stringify(currentUser));
        location.reload();
    } else {
        alert("ACCESS DENIED");
    }
}

function enableGuestMode() {
    document.getElementById('loginModal').style.display = 'none';
}

function switchMainView(name) {
    sessionStorage.setItem('lastView', name);
    document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
    const target = document.getElementById(`view-${name}`);
    if(target) target.classList.add('active');

    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    const titles = { 'top': 'HOME', 'match': 'MATCH INPUT', 'dashboard': 'DASHBOARD', 'ranking': 'RANKING', 'schedule': 'MISSION SCHEDULE', 'mypage': 'MY PAGE', 'game': 'GAME ARCHIVE' };
    const pageTitle = document.getElementById('pageTitle');
    if(pageTitle) pageTitle.textContent = titles[name] || 'TENNIS';
}

function showMyPage() {
    if (!currentUser) { document.getElementById('loginModal').style.display = 'flex'; return; }
    switchMainView('mypage');
    renderMyPage();
}

function renderMyPage() {
    const content = document.getElementById('myPageContent');
    if(!content) return;
    content.innerHTML = `
        <div class="mypage-header">
            <div class="mypage-avatar-large">${currentUser.name[0]}</div>
            <div class="mypage-name">${currentUser.name}</div>
        </div>
        <div class="mypage-coin-area"><div class="coin-val">${currentCoins.toLocaleString()}</div><div class="coin-label">CRYPTO COINS</div></div>
        <div style="text-align:center;"><button class="btn-logout" onclick="handleLogout()" style="background:transparent; color:#ff5252; border:1px solid #ff5252; padding:8px 20px; border-radius:20px; cursor:pointer;">LOGOUT</button></div>
    `;
}

function handleLogout() { localStorage.removeItem(LOGIN_KEY); location.reload(); }
function toggleSideMenu() { document.getElementById('sideMenu').classList.toggle('open'); }
function closeSideMenu(e) { if(e.target.id === 'sideMenu') document.getElementById('sideMenu').classList.remove('open'); }
function selectAppMode(m) { toggleSideMenu(); switchMainView(m === 'tennis' ? 'top' : 'game'); }

/* SLOT MACHINE LOGIC */
function openSlotGame() { 
    if(!currentUser) { showToast("LOGIN REQUIRED"); return; } 
    document.getElementById('slotGameModal').style.display='flex'; 
    slotSessionDelta=0; 
    document.getElementById('slotWallet').innerText=currentCoins.toLocaleString(); 
}

function closeSlotGame(e) { 
    if(e.target.id==='slotGameModal'||e.target.className==='close-btn') { 
        saveSlotSession(); 
        document.getElementById('slotGameModal').style.display='none'; 
    } 
}

function pullSlotLever() {
    if(isLeverLocked || currentCoins < 20) return;
    isLeverLocked = true;
    const stick = document.querySelector('.slot-lever-stick'); 
    if(stick) stick.classList.add('pulled');
    setTimeout(() => {
        if(stick) stick.classList.remove('pulled');
        currentCoins -= 20; 
        slotSessionDelta -= 20;
        document.getElementById('slotWallet').innerText = currentCoins.toLocaleString();
        updateUserDisplay();
        startSlot();
    }, 300);
}

function startSlot() {
    for(let i=0; i<3; i++) {
        isSlotSpinning[i] = true; 
        const stopBtn = document.getElementById(`stop${i+1}`);
        if(stopBtn) stopBtn.disabled = false;
        const reel = document.getElementById(`reel${i+1}`);
        if(reel) reel.classList.add('spinning');
        slotIntervals[i] = setInterval(() => {
            if(reel) reel.innerText = slotSymbols[Math.floor(Math.random()*slotSymbols.length)];
        }, 100);
    }
}

function stopReel(idx) {
    if(!isSlotSpinning[idx]) return;
    clearInterval(slotIntervals[idx]);
    isSlotSpinning[idx] = false; 
    const stopBtn = document.getElementById(`stop${idx+1}`);
    if(stopBtn) stopBtn.disabled = true;
    const reel = document.getElementById(`reel${idx+1}`);
    if(reel) reel.classList.remove('spinning');
    
    // „ÄêÈáçË¶Å„Äëüçí„ÅåÂá∫„ÇãÁ¢∫Áéá„Çí11%„Å´Âõ∫ÂÆö
    let finalSymbol;
    const rand = Math.random();
    if (rand < 0.11) {
        finalSymbol = 'üçí';
    } else {
        const others = slotSymbols.filter(s => s !== 'üçí');
        finalSymbol = others[Math.floor(Math.random() * others.length)];
    }
    
    slotValues[idx] = slotSymbols.indexOf(finalSymbol);
    if(reel) reel.innerText = finalSymbol;
    if(!isSlotSpinning.some(s=>s)) checkSlotResult();
}

function checkSlotResult() {
    const [v1,v2,v3] = slotValues.map(i=>slotSymbols[i]);
    let win = 0;
    if(v1===v2 && v2===v3) {
        if(v1==='7') win=7777; else if(v1==='üíé') win=1000; else if(v1==='üîî') win=500; else if(v1==='üçá') win=300; else if(v1==='üçí') win=100; else if(v1==='üíÄ') win=-1000;
    } else if([v1,v2,v3].includes('7')) win=20;
    currentCoins += win; 
    slotSessionDelta += win;
    const msg = document.getElementById('slotMessage');
    if(msg) msg.innerText = win>0 ? `WIN! +${win}` : (win<0 ? `LOST ${win}` : "TRY AGAIN");
    document.getElementById('slotWallet').innerText = currentCoins.toLocaleString();
    updateUserDisplay();
    isLeverLocked = false;
}

function saveSlotSession() {
    if(slotSessionDelta===0 || !COIN_MANAGER_URL || !currentUser) return;
    fetch(COIN_MANAGER_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({user:currentUser.name, action:'update', amount:slotSessionDelta}), keepalive:true });
}

/* TENNIS DATA & INITIALIZERS */
function initSelectors() {
    ['r1', 'r2'].forEach(r => {
        for(let i=1; i<=5; i++){
            const el = document.getElementById(`${r}_p${i}`);
            if(el) el.innerHTML = '<option value="-">-</option>' + members.map(m => `<option value="${m}">${m}</option>`).join('');
        }
    });
}

function fetchAnalysisData() {
    if(!GAS_WEB_APP_URL) return;
    fetch(GAS_WEB_APP_URL).then(res => res.json()).then(json => {
        if(json.status === 'success') {
            const missions = document.getElementById('totalMissions');
            if(missions) missions.textContent = json.rankings.length - 1;
        }
    }).catch(e => console.error(e));
}

function fetchWeather() {
    fetch("https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo")
    .then(res => res.json()).then(data => {
        const container = document.getElementById('weather-forecast');
        if(!container) return;
        container.innerHTML = "";
        data.daily.time.slice(0,5).forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'weather-card';
            div.innerHTML = `<div style="font-size:0.7rem;">${t.slice(5)}</div><div style="font-size:1.5rem;">${data.daily.weathercode[i]<3?'‚òÄ':'‚òÅ'}</div><div>${Math.round(data.daily.temperature_2m_max[i])}¬∞</div>`;
            container.appendChild(div);
        });
    }).catch(e => console.error(e));
}

function fetchScheduleData() {
    if(!SCHEDULE_GAS_URL) return;
    fetch(SCHEDULE_GAS_URL).then(res => res.json()).then(data => {
        const list = document.getElementById('scheduleList');
        if(!list) return;
        list.innerHTML = data.length ? "" : "NO SCHEDULE";
        data.slice(0, 5).forEach(item => {
            const li = document.createElement('div');
            li.className = 'schedule-item';
            li.innerHTML = `<span>${item.date}</span><span>‚óØ:${item.counts.ok} ‚ñ≥:${item.counts.maybe}</span>`;
            list.appendChild(li);
        });
    }).catch(e => console.error(e));
}

function toggleEditMode() {
    if(!isEditMode) {
        const pin = prompt("ENTER PASSCODE");
        if(pin === "8047") { isEditMode = true; applyEditMode(); }
    } else {
        isEditMode = false; applyEditMode();
    }
}

function applyEditMode() {
    const editBtn = document.getElementById('editBtn');
    if(editBtn) editBtn.className = isEditMode ? 'btn-ctrl unlocked' : 'btn-ctrl';
    document.querySelectorAll('select, button#sendButton, button#resetBtn').forEach(el => el.disabled = !isEditMode);
}

function manualReload() { location.reload(); }
function showToast(msg) { 
    const t=document.getElementById("toast"); 
    if(t) { t.textContent=msg; t.className="show"; setTimeout(()=>{t.className=""},3000); }
}
function playCoinToss() {
    const c = document.getElementById('gameCoin'); if(!c || c.classList.contains('spinning')) return;
    c.classList.add('spinning'); c.textContent="";
    setTimeout(() => { c.classList.remove('spinning'); c.textContent = Math.random()>0.5?"HEAD":"TAIL"; }, 1500);
}
